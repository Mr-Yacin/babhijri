---
// This component should be added to all admin pages
// It provides a client-side check in addition to middleware
---

<script>
    import { getFirebaseAuth, db } from "../../lib/firebase";
    import { doc, getDoc } from "firebase/firestore";

    const auth = getFirebaseAuth();

    // Visual elements
    const loader = document.getElementById("admin-check-loader");
    const statusText = document.getElementById("admin-check-status");

    if (auth) {
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                console.log("[AdminCheck] No user logged in, redirecting...");
                window.location.href = "/app/login";
                return;
            }

            if (statusText)
                statusText.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...";

            try {
                // Strict check: Get user document and check role
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                let isAdmin = false;

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    if (userData.role === "admin") {
                        isAdmin = true;
                    }
                }

                if (!isAdmin) {
                    console.warn(
                        "[AdminCheck] User is not admin (Role Check Failed)",
                    );
                    if (statusText)
                        statusText.textContent = "â›” ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„";

                    // Show access denied message briefly before redirecting
                    setTimeout(() => {
                        window.location.href = "/app/dashboard";
                    }, 1500);
                } else {
                    console.log("[AdminCheck] âœ“ Admin access confirmed");
                    // Dispatch event to show app shell
                    document.dispatchEvent(
                        new CustomEvent("admin-access-granted"),
                    );

                    // Hide loader
                    if (loader) {
                        loader.style.opacity = "0";
                        setTimeout(() => {
                            loader.style.display = "none";
                        }, 500);
                    }
                }
            } catch (error) {
                console.error(
                    "[AdminCheck] Error verifying admin status:",
                    error,
                );
                if (statusText) statusText.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚";
                // Fallback to safe state (redirect)
                setTimeout(() => {
                    window.location.href = "/app/dashboard";
                }, 2000);
            }
        });
    }
</script>

<!-- Visual indicator while checking -->
<div
    id="admin-check-loader"
    class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center transition-opacity duration-500"
>
    <div class="text-center">
        <div class="relative w-20 h-20 mx-auto mb-6">
            <div
                class="absolute inset-0 border-4 border-slate-700 rounded-full"
            >
            </div>
            <div
                class="absolute inset-0 border-4 border-teal-500 border-t-transparent rounded-full animate-spin"
            >
            </div>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-2xl">ğŸ›¡ï¸</span>
            </div>
        </div>
        <h2 class="text-xl font-bold text-white mb-2">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</h2>
        <p id="admin-check-status" class="text-slate-400">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...
        </p>
    </div>
</div>
