---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import AdminCheck from "../../../components/admin/AdminCheck.astro";
---

<AdminLayout title="Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
    <AdminCheck />

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">
                Ø£Ø¯Ø§Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </h1>
            <p class="text-slate-500">
                Ø¥ØµÙ„Ø§Ø­ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù…Ø«Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
                Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©.
            </p>
        </div>

        <!-- Info Banner -->
        <div
            class="bg-amber-50 border border-amber-100 rounded-2xl p-6 mb-8 flex items-start gap-4"
        >
            <div
                class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center flex-shrink-0 text-amber-600"
            >
                <span class="text-xl">âš ï¸</span>
            </div>
            <div>
                <h3 class="font-bold text-amber-900 mb-1">ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…</h3>
                <p class="text-sm text-amber-800/80 leading-relaxed">
                    Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ø³ØªÙ‚ÙˆÙ… Ø¨ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø©
                    Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ù…Ù„ÙÙ‹Ø§ Ø´Ø®ØµÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† ÙˆØ«ÙŠÙ‚Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù‚Ø§Ø¨Ù„Ø© ÙÙŠ
                    Ù…Ø¬Ù…ÙˆØ¹Ø© <code
                        class="bg-amber-100 px-1 py-0.5 rounded text-amber-900 text-xs"
                        >users</code
                    >ØŒ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Single Fix Card -->
            <div
                class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6"
            >
                <h2 class="text-lg font-bold text-slate-800 mb-4">
                    Ø¥ØµÙ„Ø§Ø­ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯
                </h2>
                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-slate-700 mb-1"
                            >Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID)</label
                        >
                        <input
                            type="text"
                            id="single-uid-input"
                            placeholder="Ø£Ø¯Ø®Ù„ UID..."
                            class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 outline-none transition-all"
                        />
                    </div>
                    <button
                        id="single-fix-btn"
                        class="w-full py-3 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition-all shadow-lg hover:shadow-slate-500/20"
                    >
                        Ø¥ØµÙ„Ø§Ø­ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    </button>
                    <div
                        id="single-status"
                        class="text-center text-sm min-h-[20px]"
                    >
                    </div>
                </div>
            </div>

            <!-- Bulk Fix Card -->
            <div
                class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6"
            >
                <h2 class="text-lg font-bold text-slate-800 mb-4">
                    Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø´Ø§Ù…Ù„
                </h2>
                <div class="space-y-6">
                    <p class="text-sm text-slate-500">
                        ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯ Ù…Ù†Ù‡Ø§ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©.
                    </p>

                    <!-- Progress -->
                    <div
                        class="bg-slate-50 rounded-xl p-4 border border-slate-100"
                    >
                        <div class="flex justify-between mb-2">
                            <span class="text-xs font-bold text-slate-500"
                                >Ø§Ù„ØªÙ‚Ø¯Ù…</span
                            >
                            <span
                                id="bulk-progress-text"
                                class="text-xs font-bold text-teal-600">0%</span
                            >
                        </div>
                        <div
                            class="w-full bg-slate-200 rounded-full h-2 overflow-hidden"
                        >
                            <div
                                id="bulk-progress-bar"
                                class="bg-teal-500 h-2 rounded-full transition-all duration-300"
                                style="width: 0%"
                            >
                            </div>
                        </div>
                    </div>

                    <button
                        id="start-fix-btn"
                        class="w-full py-3 bg-amber-600 text-white font-bold rounded-xl hover:bg-amber-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-amber-500/30"
                    >
                        <span class="flex items-center justify-center gap-2">
                            <span>ğŸ› ï¸</span>
                            <span>Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„ (Ø§Ù„ÙƒÙ„)</span>
                        </span>
                    </button>
                    <div
                        id="bulk-status"
                        class="text-center text-sm text-slate-500 min-h-[20px]"
                    >
                        Ø¬Ø§Ù‡Ø²...
                    </div>
                </div>
            </div>
        </div>

        <!-- Log Area -->
        <div
            class="mt-8 bg-slate-900 rounded-2xl shadow-lg border border-slate-800 overflow-hidden"
        >
            <div
                class="px-6 py-4 border-b border-slate-800 flex justify-between items-center"
            >
                <h3 class="font-mono text-teal-400 text-sm">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                <button
                    id="clear-log-btn"
                    class="text-xs text-slate-500 hover:text-white transition-colors"
                    >Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button
                >
            </div>
            <div
                id="log-container"
                class="h-64 overflow-y-auto p-6 font-mono text-xs space-y-2 custom-scrollbar"
            >
                <div class="text-slate-600 italic text-center mt-20">
                    Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...
                </div>
            </div>
        </div>
    </div>

    <script>
        import { db } from "../../../lib/firebase";
        import {
            collection,
            getDocs,
            doc,
            getDoc,
            setDoc,
            Timestamp,
        } from "firebase/firestore";

        // DOM Elements
        const singleUidInput = document.getElementById(
            "single-uid-input",
        ) as HTMLInputElement;
        const singleFixBtn = document.getElementById("single-fix-btn");
        const singleStatus = document.getElementById("single-status");

        const startFixBtn = document.getElementById("start-fix-btn");
        const bulkStatus = document.getElementById("bulk-status");
        const bulkProgressBar = document.getElementById("bulk-progress-bar");
        const bulkProgressText = document.getElementById("bulk-progress-text");

        const logContainer = document.getElementById("log-container");
        const clearLogBtn = document.getElementById("clear-log-btn");

        // Logger
        function log(
            message: string,
            type: "info" | "success" | "error" = "info",
        ) {
            if (!logContainer) return;

            // Remove empty state if exists
            if (logContainer.querySelector(".text-center")) {
                logContainer.innerHTML = "";
            }

            const div = document.createElement("div");
            const time = new Date().toLocaleTimeString("en-US", {
                hour12: false,
            });

            let colorClass = "text-slate-300";
            if (type === "success") colorClass = "text-green-400";
            if (type === "error") colorClass = "text-red-400";

            div.className = `${colorClass} border-b border-slate-800/50 pb-1 mb-1`;
            div.innerHTML = `<span class="opacity-50 mr-2">[${time}]</span> ${message}`;

            logContainer.insertBefore(div, logContainer.firstChild);
        }

        if (clearLogBtn) {
            clearLogBtn.addEventListener("click", () => {
                if (logContainer)
                    logContainer.innerHTML =
                        '<div class="text-slate-600 italic text-center mt-20">Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>';
            });
        }

        // Helper: Generate Email from Name
        function generateEmailFromName(displayName: string, uid: string) {
            if (!displayName) return `user_${uid.substring(0, 8)}@babhijra.com`;

            // Transliterate Arabic to English (Simple mapping)
            // This is a basic approximation, for a real app consider a library
            const arabicToEnglish: { [key: string]: string } = {
                Ø£: "a",
                Ø¨: "b",
                Øª: "t",
                Ø«: "th",
                Ø¬: "j",
                Ø­: "h",
                Ø®: "kh",
                Ø¯: "d",
                Ø°: "dh",
                Ø±: "r",
                Ø²: "z",
                Ø³: "s",
                Ø´: "sh",
                Øµ: "s",
                Ø¶: "d",
                Ø·: "t",
                Ø¸: "z",
                Ø¹: "a",
                Øº: "gh",
                Ù: "f",
                Ù‚: "q",
                Ùƒ: "k",
                Ù„: "l",
                Ù…: "m",
                Ù†: "n",
                Ù‡: "h",
                Ùˆ: "w",
                ÙŠ: "y",
                Ø©: "h",
                Ù‰: "a",
                Ø¢: "a",
                Ø¥: "e",
                Ø¦: "e",
                Ø¤: "o",
            };

            let englishName = "";
            for (let i = 0; i < displayName.length; i++) {
                const char = displayName[i];
                if (arabicToEnglish[char]) {
                    englishName += arabicToEnglish[char];
                } else if (/[a-zA-Z0-9]/.test(char)) {
                    englishName += char;
                } else if (char === " ") {
                    englishName += ".";
                }
            }

            // Clean up
            englishName = englishName
                .toLowerCase()
                .replace(/\.+/g, ".")
                .replace(/^\.| \.$/g, "");

            if (englishName.length < 3) {
                englishName = `user_${uid.substring(0, 6)}`;
            }

            const randomSuffix = Math.floor(Math.random() * 1000);
            return `${englishName}.${randomSuffix}@babhijra.com`;
        }

        // Core Logic: Fix Profile
        async function fixProfile(uid: string, profileData: any) {
            try {
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    log(`Creating missing user doc for: ${uid}`, "info");

                    // Determine email
                    let email = profileData.email;
                    if (!email) {
                        email = generateEmailFromName(
                            profileData.displayName,
                            uid,
                        );
                        log(`Generated email: ${email}`, "info");
                    }

                    const userData = {
                        uid: uid,
                        email: email,
                        displayName: profileData.displayName || "User",
                        role: "user",
                        photoURL:
                            profileData.photos && profileData.photos.length > 0
                                ? profileData.photos[0]
                                : null,
                        createdAt: profileData.createdAt || Timestamp.now(),
                        isOnline: false,
                        lastSeen: Timestamp.now(),
                    };

                    await setDoc(userRef, userData);
                    log(
                        `âœ… Successfully created user doc for ${uid}`,
                        "success",
                    );
                    return true;
                } else {
                    log(`User doc already exists for ${uid}`, "info");
                    return false;
                }
            } catch (error) {
                log(`âŒ Error fixing ${uid}: ${error}`, "error");
                throw error;
            }
        }

        // Single Fix Handler
        if (singleFixBtn) {
            singleFixBtn.addEventListener("click", async () => {
                const uid = singleUidInput.value.trim();
                if (!uid) {
                    if (singleStatus) {
                        singleStatus.textContent = "âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ UID";
                        singleStatus.className =
                            "text-center text-sm text-red-600";
                    }
                    return;
                }

                if (singleStatus) {
                    singleStatus.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...";
                    singleStatus.className =
                        "text-center text-sm text-blue-600 animate-pulse";
                }

                try {
                    // Get profile first
                    const profileRef = doc(db, "profiles", uid);
                    const profileSnap = await getDoc(profileRef);

                    if (!profileSnap.exists()) {
                        log(`Profile not found for UID: ${uid}`, "error");
                        if (singleStatus) {
                            singleStatus.textContent =
                                "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù";
                            singleStatus.className =
                                "text-center text-sm text-red-600";
                        }
                        return;
                    }

                    const fixed = await fixProfile(uid, profileSnap.data());

                    if (singleStatus) {
                        singleStatus.textContent = fixed
                            ? "âœ… ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­!"
                            : "â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§";
                        singleStatus.className = fixed
                            ? "text-center text-sm text-green-600 font-bold"
                            : "text-center text-sm text-slate-600";
                    }
                } catch (error) {
                    console.error(error);
                    if (singleStatus) {
                        singleStatus.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹";
                        singleStatus.className =
                            "text-center text-sm text-red-600";
                    }
                }
            });
        }

        // Bulk Fix Handler
        if (startFixBtn) {
            startFixBtn.addEventListener("click", async () => {
                if (
                    !confirm(
                        "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„ØŸ Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª.",
                    )
                )
                    return;

                // Reset UI
                if (startFixBtn instanceof HTMLButtonElement)
                    startFixBtn.disabled = true;
                if (bulkStatus)
                    bulkStatus.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª...";
                if (bulkProgressBar) bulkProgressBar.style.width = "0%";
                if (bulkProgressText) bulkProgressText.textContent = "0%";
                log("Starting bulk fix operation...", "info");

                try {
                    // 1. Get all profiles
                    const profilesSnap = await getDocs(
                        collection(db, "profiles"),
                    );
                    const total = profilesSnap.size;
                    log(`Found ${total} profiles to check.`, "info");

                    let processed = 0;
                    let fixedCount = 0;

                    // 2. Iterate and fix
                    for (const docSnap of profilesSnap.docs) {
                        const uid = docSnap.id;
                        const profileData = docSnap.data();

                        try {
                            const wasFixed = await fixProfile(uid, profileData);
                            if (wasFixed) fixedCount++;
                        } catch (e) {
                            // Continue even if one fails
                        }

                        processed++;
                        const progress = Math.round((processed / total) * 100);

                        // Update UI
                        if (bulkProgressBar)
                            bulkProgressBar.style.width = `${progress}%`;
                        if (bulkProgressText)
                            bulkProgressText.textContent = `${progress}%`;
                        if (bulkStatus)
                            bulkStatus.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${processed}/${total}`;

                        // Small delay to prevent freezing
                        if (processed % 5 === 0)
                            await new Promise((r) => setTimeout(r, 10));
                    }

                    // Done
                    log(
                        `ğŸ Bulk operation complete. Fixed ${fixedCount} users.`,
                        "success",
                    );
                    if (bulkStatus)
                        bulkStatus.textContent = `âœ¨ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡! ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixedCount} Ù…Ø³ØªØ®Ø¯Ù….`;
                    if (startFixBtn instanceof HTMLButtonElement)
                        startFixBtn.disabled = false;
                } catch (error) {
                    log(`âŒ Critical error in bulk fix: ${error}`, "error");
                    if (bulkStatus)
                        bulkStatus.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
                    if (startFixBtn instanceof HTMLButtonElement)
                        startFixBtn.disabled = false;
                }
            });
        }
    </script>
</AdminLayout>
