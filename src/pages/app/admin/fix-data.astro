---
import AdminLayout from "../../../layouts/AdminLayout.astro";
---

<AdminLayout title="Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
    <div class="max-w-4xl mx-auto">
        <!-- Info Banner -->
        <div class="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-6">
            <div class="flex items-start gap-3">
                <span class="text-2xl">ğŸ”§</span>
                <div>
                    <h3 class="font-bold text-amber-900 mb-1">
                        Ø£Ø¯Ø§Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </h3>
                    <p class="text-sm text-amber-800">
                        Ø³ØªÙ‚ÙˆÙ… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© Ø¨ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª
                        Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…ÙÙ‚ÙˆØ¯Ø© Ù„Ù‡Ø§. Ù‡Ø°Ø§ Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„ØªÙŠ ØªÙ…Øª
                        Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£Ùˆ Ø¹Ø¨Ø± Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©.
                        <strong>ØªØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</strong>
                    </p>
                </div>
            </div>
        </div>

        <!-- Action Card -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
            <!-- Auth Status -->
            <div
                id="auth-status"
                class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"
            >
                <div class="inline-flex items-center gap-2">
                    <div
                        class="w-5 h-5 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin"
                    >
                    </div>
                    <span class="text-gray-700"
                        >Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...</span
                    >
                </div>
            </div>

            <!-- Fix Single User Section -->
            <div class="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
                <h4 class="font-bold text-gray-700 mb-4">Ø¥ØµÙ„Ø§Ø­ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯</h4>
                <div class="flex gap-4">
                    <input
                        type="text"
                        id="target-uid"
                        placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID)"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none"
                    />
                    <button
                        id="fix-single-btn"
                        disabled
                        class="px-6 py-2 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all shadow-md"
                    >
                        Ø¥ØµÙ„Ø§Ø­ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    </button>
                </div>
            </div>

            <div class="border-t border-gray-200 my-6"></div>

            <!-- Bulk Fix Section -->
            <div class="text-center mb-6">
                <h4 class="font-bold text-gray-700 mb-4">Ø£Ùˆ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙƒÙ„</h4>
                <button
                    id="start-fix-btn"
                    disabled
                    class="px-8 py-4 bg-amber-600 text-white font-bold rounded-xl hover:bg-amber-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                >
                    <span class="flex items-center justify-center gap-2">
                        <span>ğŸ› ï¸</span>
                        <span>Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø´Ø§Ù…Ù„ (Ø§Ù„ÙƒÙ„)</span>
                    </span>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Ø§Ù„ØªÙ‚Ø¯Ù…</span
                    >
                    <span
                        id="progress-text"
                        class="text-sm font-bold text-teal-600">0%</span
                    >
                </div>
                <div
                    class="w-full bg-gray-200 rounded-full h-3 overflow-hidden"
                >
                    <div
                        id="progress-bar"
                        class="bg-gradient-to-r from-teal-500 to-teal-600 h-3 rounded-full transition-all duration-300 shadow-lg"
                        style="width:0%"
                    >
                    </div>
                </div>
            </div>

            <!-- Status Message -->
            <div
                id="status-message"
                class="text-center text-gray-600 mb-6 min-h-[24px]"
            >
            </div>

            <!-- Results List -->
            <div
                class="border border-gray-200 rounded-xl overflow-hidden bg-gray-50"
            >
                <div
                    class="bg-gradient-to-r from-gray-100 to-gray-50 px-4 py-3 border-b border-gray-200"
                >
                    <h3 class="font-semibold text-gray-700 text-sm">
                        Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                    </h3>
                </div>
                <div class="max-h-64 overflow-y-auto p-4">
                    <ul id="results-list" class="space-y-2">
                        <li class="text-gray-400 text-sm text-center py-4">
                            Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script define:vars={{ adminEmailsStr: import.meta.env.ADMIN_EMAILS || "" }}
    >
        import { db, auth } from "../../../lib/firebase";
        import {
            collection,
            getDocs,
            doc,
            getDoc,
            setDoc,
            Timestamp,
        } from "firebase/firestore";
        import { onAuthStateChanged } from "firebase/auth";

        const startBtn = document.getElementById("start-fix-btn");
        const fixSingleBtn = document.getElementById("fix-single-btn");
        const targetUidInput = document.getElementById("target-uid");
        const statusDiv = document.getElementById("status-message");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        const resultsList = document.getElementById("results-list");
        const authStatus = document.getElementById("auth-status");

        const adminEmails = adminEmailsStr
            .split(",")
            .map((e) => e.trim().toLowerCase());
        let currentUser = null;

        // Check auth status
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (authStatus) {
                if (user) {
                    try {
                        // Check by Email (fallback if user doc missing)
                        const isEmailAdmin = adminEmails.includes(
                            user.email?.toLowerCase(),
                        );

                        // Check by Role
                        let isRoleAdmin = false;
                        const userDoc = await getDoc(
                            doc(db, "users", user.uid),
                        );
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            isRoleAdmin = userData?.role === "admin";
                        }

                        if (isRoleAdmin || isEmailAdmin) {
                            authStatus.innerHTML = `
                                <div class="flex items-center justify-center gap-2 text-green-700">
                                    <span class="text-xl">âœ…</span>
                                    <span class="font-medium">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„: ${user.email}</span>
                                </div>
                            `;
                            if (startBtn) startBtn.disabled = false;
                            if (fixSingleBtn) fixSingleBtn.disabled = false;
                        } else {
                            authStatus.innerHTML = `
                                <div class="flex items-center justify-center gap-2 text-red-700">
                                    <span class="text-xl">âŒ</span>
                                    <span class="font-medium">ØºÙŠØ± Ù…ØµØ±Ø­. Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙƒÙ…Ø³Ø¤ÙˆÙ„.</span>
                                </div>
                            `;
                            if (startBtn) startBtn.disabled = true;
                            if (fixSingleBtn) fixSingleBtn.disabled = true;
                        }
                    } catch (error) {
                        console.error("Error checking admin status:", error);
                        authStatus.innerHTML = `
                            <div class="flex items-center justify-center gap-2 text-red-700">
                                <span class="text-xl">âŒ</span>
                                <span class="font-medium">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
                            </div>
                        `;
                        if (startBtn) startBtn.disabled = true;
                        if (fixSingleBtn) fixSingleBtn.disabled = true;
                    }
                } else {
                    authStatus.innerHTML = `
                        <div class="flex items-center justify-center gap-2 text-amber-700">
                            <span class="text-xl">âš ï¸</span>
                            <span class="font-medium">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„ Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                        </div>
                    `;
                    if (startBtn) startBtn.disabled = true;
                    if (fixSingleBtn) fixSingleBtn.disabled = true;
                }
            }
        });

        async function fixProfile(uid, profileData) {
            try {
                // Check if user doc exists
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);

                if (!userSnap.exists()) {
                    // Create missing user document
                    const userData = {
                        uid: uid,
                        displayName: profileData.displayName || "Unknown",
                        email: profileData.email || `${uid}@example.com`,
                        photoURL: profileData.photos?.[0] || null,
                        role: "user",
                        createdAt: profileData.createdAt || Timestamp.now(),
                        updatedAt: Timestamp.now(),
                    };

                    await setDoc(userRef, userData);

                    const li = document.createElement("li");
                    li.className =
                        "flex items-center gap-2 text-sm text-green-700 bg-green-50 p-2 rounded-lg";
                    li.innerHTML = `<span class="font-bold">âœ…</span> <span>ØªÙ… Ø¥ØµÙ„Ø§Ø­: ${profileData.displayName} (${uid})</span>`;
                    if (resultsList) resultsList.appendChild(li);
                    return true;
                } else {
                    const li = document.createElement("li");
                    li.className =
                        "flex items-center gap-2 text-sm text-blue-700 bg-blue-50 p-2 rounded-lg";
                    li.innerHTML = `<span class="font-bold">â„¹ï¸</span> <span>Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹: ${profileData.displayName}</span>`;
                    if (resultsList) resultsList.appendChild(li);
                    return false;
                }
            } catch (err) {
                console.error(err);
                const li = document.createElement("li");
                li.className =
                    "flex items-center gap-2 text-sm text-red-700 bg-red-50 p-2 rounded-lg";
                li.innerHTML = `<span class="font-bold">âŒ</span> <span>Ø®Ø·Ø£: ${profileData.displayName || uid}</span>`;
                if (resultsList) resultsList.appendChild(li);
                throw err;
            }
        }

        // Fix Single User Logic
        if (fixSingleBtn && targetUidInput) {
            fixSingleBtn.addEventListener("click", async () => {
                const uid = targetUidInput.value.trim();
                if (!uid) {
                    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID)");
                    return;
                }

                fixSingleBtn.disabled = true;
                if (statusDiv)
                    statusDiv.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ...";
                if (resultsList) resultsList.innerHTML = "";

                try {
                    const profileDoc = await getDoc(doc(db, "profiles", uid));

                    if (profileDoc.exists()) {
                        const profileData = profileDoc.data();
                        await fixProfile(uid, profileData);
                        if (statusDiv) statusDiv.textContent = "âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
                    } else {
                        if (statusDiv)
                            statusDiv.textContent =
                                "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù";
                        const li = document.createElement("li");
                        li.className =
                            "flex items-center gap-2 text-sm text-red-700 bg-red-50 p-2 rounded-lg";
                        li.innerHTML = `<span class="font-bold">âŒ</span> <span>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø´Ø®ØµÙŠ: ${uid}</span>`;
                        if (resultsList) resultsList.appendChild(li);
                    }
                } catch (error) {
                    console.error("Error fixing single user:", error);
                    if (statusDiv)
                        statusDiv.textContent = `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}`;
                } finally {
                    fixSingleBtn.disabled = false;
                }
            });
        }

        if (startBtn) {
            startBtn.addEventListener("click", async () => {
                if (
                    !confirm(
                        "âš ï¸ Ø³ÙŠØªÙ… ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ù„Ù„Ù…ÙÙ‚ÙˆØ¯ÙŠÙ†. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ",
                    )
                ) {
                    return;
                }

                startBtn.disabled = true;
                startBtn.classList.add("opacity-50");
                if (statusDiv)
                    statusDiv.textContent = "â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";
                if (resultsList) resultsList.innerHTML = "";

                try {
                    const profilesRef = collection(db, "profiles");
                    const snapshot = await getDocs(profilesRef);
                    const total = snapshot.size;

                    let fixedCount = 0;
                    let skippedCount = 0;
                    let errorCount = 0;

                    let i = 0;
                    for (const profileDoc of snapshot.docs) {
                        i++;
                        const profileData = profileDoc.data();
                        const uid = profileDoc.id;

                        // Update progress
                        const progress = Math.round((i / total) * 100);
                        if (progressBar)
                            progressBar.style.width = `${progress}%`;
                        if (progressText)
                            progressText.textContent = `${progress}%`;

                        try {
                            const fixed = await fixProfile(uid, profileData);
                            if (fixed) fixedCount++;
                            else skippedCount++;
                        } catch (err) {
                            errorCount++;
                        }

                        // Auto-scroll
                        if (resultsList && resultsList.lastElementChild) {
                            resultsList.lastElementChild.scrollIntoView({
                                behavior: "smooth",
                            });
                        }

                        // Small delay to prevent freezing
                        await new Promise((r) => setTimeout(r, 50));
                    }

                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="text-green-700 font-bold">
                                ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ÙØ­Øµ! ØªÙ… Ø¥ØµÙ„Ø§Ø­ ${fixedCount}ØŒ ØªØ®Ø·ÙŠ ${skippedCount}ØŒ Ø£Ø®Ø·Ø§Ø¡ ${errorCount}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error("Fatal error:", error);
                    if (statusDiv) {
                        statusDiv.innerHTML = `
                            <div class="text-red-700 font-bold">
                                âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${error.message}
                            </div>
                        `;
                    }
                } finally {
                    startBtn.disabled = false;
                    startBtn.classList.remove("opacity-50");
                }
            });
        }
    </script>
</AdminLayout>
