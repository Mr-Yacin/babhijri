---
import AdminLayout from "../../../layouts/AdminLayout.astro";
---

<AdminLayout title="Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©">
    <div class="max-w-4xl mx-auto">
        <!-- Info Banner -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
            <div class="flex items-start gap-3">
                <span class="text-2xl">â„¹ï¸</span>
                <div>
                    <h3 class="font-bold text-blue-900 mb-1">
                        Ø£Ø¯Ø§Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                    </h3>
                    <p class="text-sm text-blue-800">
                        Ø³ØªØ¶ÙŠÙ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø© 20 Ù…Ù„ÙÙ‹Ø§ Ø´Ø®ØµÙŠÙ‹Ø§ ØªØ¬Ø±ÙŠØ¨ÙŠÙ‹Ø§ Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø©
                        Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firestore. Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±. <strong
                            >ØªØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.</strong
                        >
                    </p>
                </div>
            </div>
        </div>

        <!-- Seeding Card -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
            <!-- Auth Status -->
            <div
                id="auth-status"
                class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 text-center"
            >
                <div class="inline-flex items-center gap-2">
                    <div
                        class="w-5 h-5 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin"
                    >
                    </div>
                    <span class="text-gray-700"
                        >Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„...</span
                    >
                </div>
            </div>

            <!-- Start Button -->
            <div class="flex justify-center mb-6">
                <button
                    id="start-seed-btn"
                    disabled
                    class="px-8 py-4 bg-teal-600 text-white font-bold rounded-xl hover:bg-teal-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                >
                    <span class="flex items-center gap-2">
                        <span>ğŸŒ±</span>
                        <span>Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©</span>
                    </span>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">Ø§Ù„ØªÙ‚Ø¯Ù…</span
                    >
                    <span
                        id="progress-text"
                        class="text-sm font-bold text-teal-600">0%</span
                    >
                </div>
                <div
                    class="w-full bg-gray-200 rounded-full h-3 overflow-hidden"
                >
                    <div
                        id="progress-bar"
                        class="bg-gradient-to-r from-teal-500 to-teal-600 h-3 rounded-full transition-all duration-300 shadow-lg"
                        style="width:0%"
                    >
                    </div>
                </div>
            </div>

            <!-- Status Message -->
            <div
                id="status-message"
                class="text-center text-gray-600 mb-6 min-h-[24px]"
            >
            </div>

            <!-- Results List -->
            <div
                class="border border-gray-200 rounded-xl overflow-hidden bg-gray-50"
            >
                <div
                    class="bg-gradient-to-r from-gray-100 to-gray-50 px-4 py-3 border-b border-gray-200"
                >
                    <h3 class="font-semibold text-gray-700 text-sm">
                        Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </h3>
                </div>
                <div class="max-h-64 overflow-y-auto p-4">
                    <ul id="results-list" class="space-y-2">
                        <li class="text-gray-400 text-sm text-center py-4">
                            Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§...
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        import { db } from "../../../lib/firebase";
        import { doc, setDoc, getDoc } from "firebase/firestore";
        import { auth } from "../../../lib/firebase";
        import { onAuthStateChanged } from "firebase/auth";
        import { MOCK_PROFILES } from "../../../lib/data/mockProfiles";

        const startBtn = document.getElementById(
            "start-seed-btn",
        ) as HTMLButtonElement;
        const statusDiv = document.getElementById("status-message");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        const resultsList = document.getElementById("results-list");
        const authStatus = document.getElementById("auth-status");

        let currentUser = null;

        // Check auth status
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (authStatus) {
                if (user) {
                    try {
                        const userDoc = await getDoc(
                            doc(db, "users", user.uid),
                        );
                        const userData = userDoc.data();
                        const isAdmin = userData?.role === "admin";

                        if (isAdmin) {
                            authStatus.innerHTML = `
                                <div class="flex items-center justify-center gap-2 text-green-700">
                                    <span class="text-xl">âœ…</span>
                                    <span class="font-medium">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„: ${user.email}</span>
                                </div>
                            `;
                            startBtn.disabled = false;
                        } else {
                            authStatus.innerHTML = `
                                <div class="flex items-center justify-center gap-2 text-red-700">
                                    <span class="text-xl">âŒ</span>
                                    <span class="font-medium">ØºÙŠØ± Ù…ØµØ±Ø­. Ø§Ù„Ø¯ÙˆØ±: ${userData?.role || "Ù…Ø³ØªØ®Ø¯Ù…"}</span>
                                </div>
                            `;
                            startBtn.disabled = true;
                        }
                    } catch (error) {
                        console.error("Error checking admin status:", error);
                        authStatus.innerHTML = `
                            <div class="flex items-center justify-center gap-2 text-red-700">
                                <span class="text-xl">âŒ</span>
                                <span class="font-medium">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
                            </div>
                        `;
                        startBtn.disabled = true;
                    }
                } else {
                    authStatus.innerHTML = `
                        <div class="flex items-center justify-center gap-2 text-amber-700">
                            <span class="text-xl">âš ï¸</span>
                            <span class="font-medium">ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                        </div>
                    `;
                    startBtn.disabled = true;
                }
            }
        });

        if (startBtn) {
            startBtn.addEventListener("click", async () => {
                if (
                    !confirm(
                        "âš ï¸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© 20 Ù…Ù„Ù Ø´Ø®ØµÙŠ Ø¥Ù„Ù‰ Firestore. Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ",
                    )
                ) {
                    return;
                }

                // Disable button and update UI
                startBtn.disabled = true;
                startBtn.classList.add("opacity-50");
                if (statusDiv)
                    statusDiv.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ©...";
                if (resultsList) resultsList.innerHTML = "";

                let successCount = 0;
                let errorCount = 0;

                for (let i = 0; i < MOCK_PROFILES.length; i++) {
                    const profile = MOCK_PROFILES[i];
                    const progress = Math.round(
                        ((i + 1) / MOCK_PROFILES.length) * 100,
                    );

                    if (progressBar) progressBar.style.width = `${progress}%`;
                    if (progressText) progressText.textContent = `${progress}%`;

                    try {
                        const profileData = {
                            ...profile,
                            createdAt: new Date(),
                            updatedAt: new Date(),
                        };

                        await setDoc(
                            doc(db, "profiles", profile.uid),
                            profileData,
                        );

                        successCount++;
                        const li = document.createElement("li");
                        li.className =
                            "flex items-center gap-2 text-sm text-green-700 bg-green-50 p-2 rounded-lg";
                        li.innerHTML = `<span class="font-bold">âœ…</span> <span>${profile.displayName}</span>`;
                        resultsList?.appendChild(li);
                    } catch (error: any) {
                        console.error("Error seeding profile:", error);
                        errorCount++;
                        const li = document.createElement("li");
                        li.className =
                            "flex items-center gap-2 text-sm text-red-700 bg-red-50 p-2 rounded-lg";
                        li.innerHTML = `<span class="font-bold">âŒ</span> <span>${profile.displayName}: ${error.message}</span>`;
                        resultsList?.appendChild(li);
                    }

                    // Auto-scroll to latest result
                    resultsList?.lastElementChild?.scrollIntoView({
                        behavior: "smooth",
                    });

                    // Small delay for visual feedback
                    await new Promise((resolve) => setTimeout(resolve, 150));
                }

                // Final status
                if (statusDiv) {
                    if (successCount === MOCK_PROFILES.length) {
                        statusDiv.innerHTML = `
                            <div class="text-green-700 font-bold">
                                ğŸ‰ Ù†Ø¬Ø§Ø­! ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ ${successCount} Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­!
                            </div>
                        `;
                    } else if (successCount > 0) {
                        statusDiv.innerHTML = `
                            <div class="text-amber-700 font-bold">
                                âš ï¸ Ø§ÙƒØªÙ…Ù„ Ø¬Ø²Ø¦ÙŠÙ‹Ø§: ${successCount} Ù†Ø¬Ø­ØŒ ${errorCount} ÙØ´Ù„
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="text-red-700 font-bold">
                                âŒ ÙØ´Ù„Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.
                            </div>
                        `;
                    }
                }

                // Re-enable button
                startBtn.disabled = false;
                startBtn.classList.remove("opacity-50");
                startBtn.innerHTML = `
                    <span class="flex items-center gap-2">
                        <span>ğŸ”„</span>
                        <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</span>
                    </span>
                `;
            });
        }
    </script>
</AdminLayout>
