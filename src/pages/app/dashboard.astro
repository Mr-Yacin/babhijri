---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/common/Header.astro";
import Footer from "../../components/common/Footer.astro";
import { SITE_CONFIG } from "../../config";
---

<Layout title={`لوحة التحكم | ${SITE_CONFIG.name}`}>
    <Header />

    <main class="min-h-screen bg-gray-50" dir="rtl">
        <!-- Page Header -->
        <section
            class="bg-gradient-to-r from-teal-900 to-teal-700 text-white py-12"
        >
            <div class="container mx-auto px-4">
                <h1 class="text-3xl md:text-4xl font-bold mb-2">لوحة التحكم</h1>
                <p class="text-teal-100 text-lg">
                    مرحباً بك! تابع نشاطك وإحصائياتك
                </p>
            </div>
        </section>

        <!-- Dashboard Content -->
        <div class="container mx-auto px-4 py-8">
            <!-- Profile Completion Banner -->
            <div id="completion-banner" class="hidden mb-6">
                <div
                    class="bg-gradient-to-r from-pink-500 to-pink-600 rounded-xl p-6 text-white shadow-lg"
                >
                    <div class="flex items-start gap-4">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-8 w-8 flex-shrink-0"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path>
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">
                                أكمل ملفك الشخصي
                            </h3>
                            <p class="text-pink-100 mb-3">
                                ملفك الشخصي مكتمل بنسبة <span
                                    id="banner-completion"
                                    class="font-bold">0%</span
                                >. أكمل المعلومات لزيادة فرصك في العثور على شريك
                                مناسب.
                            </p>
                            <a
                                href="/app/profile/edit"
                                class="inline-block bg-white text-pink-600 px-6 py-2 rounded-lg font-semibold hover:bg-pink-50 transition-colors"
                            >
                                أكمل الملف الآن
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Profile Views -->
                <div
                    class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow"
                >
                    <div class="flex items-center justify-between mb-4">
                        <div
                            class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 text-blue-600"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                                ></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-gray-500 text-sm mb-1">مشاهدات الملف</h3>
                    <p id="stat-views" class="text-3xl font-bold text-gray-900">
                        0
                    </p>
                </div>

                <!-- Likes Received -->
                <div
                    class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow"
                >
                    <div class="flex items-center justify-between mb-4">
                        <div
                            class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 text-pink-600"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                                ></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-gray-500 text-sm mb-1">الإعجابات</h3>
                    <p id="stat-likes" class="text-3xl font-bold text-gray-900">
                        0
                    </p>
                </div>

                <!-- Matches -->
                <div
                    class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow"
                >
                    <div class="flex items-center justify-between mb-4">
                        <div
                            class="w-12 h-12 bg-teal-100 rounded-lg flex items-center justify-center"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 text-teal-600"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                                ></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-gray-500 text-sm mb-1">التطابقات</h3>
                    <p
                        id="stat-matches"
                        class="text-3xl font-bold text-gray-900"
                    >
                        0
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Quick Actions -->
                    <div
                        class="bg-white rounded-xl p-6 shadow-sm border border-gray-100"
                    >
                        <h2 class="text-xl font-bold text-gray-900 mb-4">
                            إجراءات سريعة
                        </h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <a
                                href="/app"
                                class="flex items-center gap-4 p-4 bg-gradient-to-r from-teal-50 to-teal-100 rounded-lg hover:from-teal-100 hover:to-teal-200 transition-all group"
                            >
                                <div
                                    class="w-12 h-12 bg-teal-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-6 w-6 text-white"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                                        ></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">
                                        تصفح الملفات
                                    </h3>
                                    <p class="text-sm text-gray-600">
                                        اكتشف أشخاص جدد
                                    </p>
                                </div>
                            </a>

                            <a
                                href="/app/profile/edit"
                                class="flex items-center gap-4 p-4 bg-gradient-to-r from-pink-50 to-pink-100 rounded-lg hover:from-pink-100 hover:to-pink-200 transition-all group"
                            >
                                <div
                                    class="w-12 h-12 bg-pink-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-6 w-6 text-white"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                        ></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">
                                        تعديل الملف
                                    </h3>
                                    <p class="text-sm text-gray-600">
                                        حدّث معلوماتك
                                    </p>
                                </div>
                            </a>

                            <a
                                href="/app/profile"
                                class="flex items-center gap-4 p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg hover:from-purple-100 hover:to-purple-200 transition-all group"
                            >
                                <div
                                    class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-6 w-6 text-white"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                        ></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">
                                        ملفي الشخصي
                                    </h3>
                                    <p class="text-sm text-gray-600">
                                        عرض ملفك
                                    </p>
                                </div>
                            </a>

                            <a
                                href="/app/settings"
                                class="flex items-center gap-4 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg hover:from-gray-100 hover:to-gray-200 transition-all group"
                            >
                                <div
                                    class="w-12 h-12 bg-gray-600 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-6 w-6 text-white"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                                        ></path>
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                        ></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">
                                        الإعدادات
                                    </h3>
                                    <p class="text-sm text-gray-600">
                                        إدارة حسابك
                                    </p>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div
                        class="bg-white rounded-xl p-6 shadow-sm border border-gray-100"
                    >
                        <h2 class="text-xl font-bold text-gray-900 mb-4">
                            النشاط الأخير
                        </h2>
                        <div id="recent-activity" class="space-y-3">
                            <!-- Activity items will be inserted here -->
                            <div class="text-center py-8 text-gray-400">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-12 w-12 mx-auto mb-3 opacity-50"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                                <p>لا يوجد نشاط حديث</p>
                                <p class="text-sm mt-1">
                                    ابدأ بتصفح الملفات للحصول على تطابقات
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- Profile Status -->
                    <div
                        class="bg-white rounded-xl p-6 shadow-sm border border-gray-100"
                    >
                        <h3 class="font-bold text-gray-900 mb-4">
                            حالة الملف الشخصي
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">الحالة</span>
                                <span
                                    id="profile-status"
                                    class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium"
                                >
                                    نشط
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600">الاكتمال</span>
                                <span
                                    id="profile-completion"
                                    class="text-gray-900 font-semibold">0%</span
                                >
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div
                                    id="completion-bar"
                                    class="bg-teal-600 h-2 rounded-full transition-all duration-500"
                                    style="width: 0%"
                                >
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tips -->
                    <div
                        class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-xl p-6 border border-teal-200"
                    >
                        <div class="flex items-start gap-3 mb-3">
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 text-teal-600 flex-shrink-0"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                                ></path>
                            </svg>
                            <div>
                                <h4 class="font-bold text-teal-900 mb-2">
                                    نصائح لتحسين ملفك
                                </h4>
                                <ul class="text-sm text-teal-800 space-y-2">
                                    <li class="flex items-start gap-2">
                                        <span class="text-teal-600">•</span>
                                        <span
                                            >أضف صوراً واضحة وحديثة لملفك الشخصي</span
                                        >
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-teal-600">•</span>
                                        <span
                                            >اكتب نبذة مفصلة عن نفسك واهتماماتك</span
                                        >
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="text-teal-600">•</span>
                                        <span
                                            >كن نشطاً وتفاعل مع الملفات الأخرى</span
                                        >
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <Footer />
</Layout>

<script>
    import { authStore } from "../../lib/stores/auth";
    import { ProfileService } from "../../lib/services/profile";

    const els = {
        statViews: document.getElementById("stat-views"),
        statLikes: document.getElementById("stat-likes"),
        statMatches: document.getElementById("stat-matches"),
        profileStatus: document.getElementById("profile-status"),
        profileCompletion: document.getElementById("profile-completion"),
        completionBar: document.getElementById("completion-bar"),
        completionBanner: document.getElementById("completion-banner"),
        bannerCompletion: document.getElementById("banner-completion"),
    };

    authStore.subscribe(async (state) => {
        if (state.user) {
            try {
                // Get profile
                const profile = await ProfileService.getProfile(state.user.uid);

                if (profile) {
                    // Calculate completion
                    const completion =
                        ProfileService.calculateProfileCompletion(profile);

                    // Update completion displays
                    if (els.profileCompletion) {
                        els.profileCompletion.textContent = `${completion}%`;
                    }
                    if (els.completionBar) {
                        els.completionBar.style.width = `${completion}%`;
                    }

                    // Show banner if profile is incomplete
                    if (completion < 100 && els.completionBanner) {
                        els.completionBanner.classList.remove("hidden");
                        if (els.bannerCompletion) {
                            els.bannerCompletion.textContent = `${completion}%`;
                        }
                    }

                    // Update profile status
                    if (els.profileStatus) {
                        if (profile.isActive) {
                            els.profileStatus.textContent = "نشط";
                            els.profileStatus.className =
                                "px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium";
                        } else {
                            els.profileStatus.textContent = "غير نشط";
                            els.profileStatus.className =
                                "px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium";
                        }
                    }

                    // Get and display stats
                    const stats = await ProfileService.getProfileStats(
                        state.user.uid,
                    );
                    if (els.statViews)
                        els.statViews.textContent = stats.views.toString();
                    if (els.statLikes)
                        els.statLikes.textContent = stats.likes.toString();
                    if (els.statMatches)
                        els.statMatches.textContent = stats.matches.toString();
                } else {
                    // No profile, redirect to create
                    window.location.href = "/app/profile/create";
                }
            } catch (error) {
                console.error("Error loading dashboard:", error);
            }
        } else if (!state.loading) {
            // Not logged in, redirect to login
            window.location.href = "/app/login";
        }
    });
</script>
