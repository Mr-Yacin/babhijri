---
import Layout from "../../../layouts/Layout.astro";
import Header from "../../../components/common/Header.astro";
---

<Layout title="الملف الشخصي | BabHijra">
    <Header />

    <div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8" dir="rtl">
        <div class="max-w-4xl mx-auto">
            <!-- Profile Header -->
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-8">
                <div class="h-32 bg-gradient-to-r from-teal-500 to-teal-600">
                </div>
                <div class="px-8 pb-8">
                    <div
                        class="relative flex flex-col md:flex-row items-end -mt-12 mb-6 gap-4"
                    >
                        <div
                            class="w-32 h-32 rounded-full border-4 border-white bg-gray-200 overflow-hidden shadow-md flex-shrink-0 z-10"
                        >
                            <!-- Profile Image Container -->
                            <div
                                id="profile-image-container"
                                class="w-full h-full bg-gray-100 flex items-center justify-center text-gray-400"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-16 w-16"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="1.5"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                    ></path>
                                </svg>
                            </div>
                        </div>

                        <div class="flex-1 text-right md:mr-4 w-full">
                            <h1
                                id="profile-name"
                                class="text-2xl font-bold text-gray-900 mb-1"
                            >
                                جاري التحميل...
                            </h1>
                            <p
                                id="profile-location"
                                class="text-gray-500 flex items-center gap-1"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-4 w-4"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                    ></path>
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                    ></path>
                                </svg>
                                <span>...</span>
                            </p>
                        </div>

                        <div class="flex gap-3 w-full md:w-auto mt-4 md:mt-0">
                            <button
                                id="share-profile-btn"
                                class="w-full md:w-auto px-4 py-2.5 bg-white border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium flex items-center justify-center gap-2 shadow-sm"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"
                                    ></path>
                                </svg>
                                مشاركة
                            </button>
                            <a
                                href="/app/profile/edit"
                                class="w-full md:w-auto px-6 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium text-center flex items-center justify-center gap-2"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-5 w-5"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                    ></path>
                                </svg>
                                تعديل الملف
                            </a>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2 space-y-8">
                            <!-- About -->
                            <section class="bg-white">
                                <h2
                                    class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-teal-600"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                        ></path>
                                    </svg>
                                    نبذة عني
                                </h2>
                                <p
                                    id="profile-bio"
                                    class="text-gray-600 leading-relaxed whitespace-pre-line"
                                >
                                    ...
                                </p>
                            </section>

                            <!-- Interests -->
                            <section>
                                <h2
                                    class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-teal-600"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                        ></path>
                                    </svg>
                                    الاهتمامات
                                </h2>
                                <div
                                    id="profile-interests"
                                    class="flex flex-wrap gap-2"
                                >
                                    <!-- Interests will go here -->
                                </div>
                            </section>

                            <!-- Photos Gallery -->
                            <section>
                                <h2
                                    class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-teal-600"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                        ></path>
                                    </svg>
                                    الصور
                                </h2>
                                <div
                                    id="profile-photos"
                                    class="grid grid-cols-2 sm:grid-cols-3 gap-4"
                                >
                                    <!-- Photos will go here -->
                                </div>
                            </section>
                        </div>

                        <div class="space-y-6">
                            <!-- Profile Completion Card -->
                            <div
                                class="bg-white rounded-xl p-6 border border-gray-100 shadow-sm"
                            >
                                <h3 class="font-bold text-gray-900 mb-4">
                                    اكتمال الملف الشخصي
                                </h3>
                                <div class="relative pt-1">
                                    <div
                                        class="flex mb-2 items-center justify-between"
                                    >
                                        <div>
                                            <span
                                                id="completion-percentage"
                                                class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-teal-600 bg-teal-200"
                                            >
                                                0%
                                            </span>
                                        </div>
                                    </div>
                                    <div
                                        class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-teal-100"
                                    >
                                        <div
                                            id="completion-bar"
                                            style="width:0%"
                                            class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-teal-500 transition-all duration-500"
                                        >
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500">
                                        أكمل ملفك لتزيد فرصك في العثور على شريك
                                        مناسب.
                                    </p>
                                </div>
                            </div>

                            <!-- Details Card -->
                            <div
                                class="bg-gray-50 rounded-xl p-6 border border-gray-100"
                            >
                                <h3
                                    class="font-bold text-gray-900 mb-4 border-b border-gray-200 pb-2"
                                >
                                    المعلومات الشخصية
                                </h3>
                                <ul class="space-y-4 text-sm">
                                    <li
                                        class="flex justify-between items-center"
                                    >
                                        <span class="text-gray-500">العمر</span>
                                        <span
                                            id="profile-age"
                                            class="text-gray-900 font-semibold bg-white px-2 py-1 rounded shadow-sm"
                                            >--</span
                                        >
                                    </li>
                                    <li
                                        class="flex justify-between items-center"
                                    >
                                        <span class="text-gray-500"
                                            >الحالة الاجتماعية</span
                                        >
                                        <span
                                            id="profile-status"
                                            class="text-gray-900 font-semibold bg-white px-2 py-1 rounded shadow-sm"
                                            >--</span
                                        >
                                    </li>
                                    <li
                                        class="flex justify-between items-center"
                                    >
                                        <span class="text-gray-500"
                                            >التعليم</span
                                        >
                                        <span
                                            id="profile-education"
                                            class="text-gray-900 font-semibold bg-white px-2 py-1 rounded shadow-sm"
                                            >--</span
                                        >
                                    </li>
                                    <li
                                        class="flex justify-between items-center"
                                    >
                                        <span class="text-gray-500">المهنة</span
                                        >
                                        <span
                                            id="profile-occupation"
                                            class="text-gray-900 font-semibold bg-white px-2 py-1 rounded shadow-sm"
                                            >--</span
                                        >
                                    </li>
                                    <li
                                        class="flex justify-between items-center"
                                    >
                                        <span class="text-gray-500"
                                            >أبحث عن</span
                                        >
                                        <span
                                            id="profile-looking-for"
                                            class="text-gray-900 font-semibold bg-white px-2 py-1 rounded shadow-sm"
                                            >--</span
                                        >
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { authStore } from "../../../lib/stores/auth";
    import { ProfileService } from "../../../lib/services/profile";

    const els = {
        name: document.getElementById("profile-name"),
        location: document.querySelector("#profile-location span"),
        bio: document.getElementById("profile-bio"),
        interests: document.getElementById("profile-interests"),
        photos: document.getElementById("profile-photos"),
        age: document.getElementById("profile-age"),
        status: document.getElementById("profile-status"),
        education: document.getElementById("profile-education"),
        occupation: document.getElementById("profile-occupation"),
        lookingFor: document.getElementById("profile-looking-for"),
        imageContainer: document.getElementById("profile-image-container"),
        completionPercentage: document.getElementById("completion-percentage"),
        completionBar: document.getElementById("completion-bar"),
        shareBtn: document.getElementById("share-profile-btn"),
    };

    // Share button logic
    const shareBtn = els.shareBtn;
    if (shareBtn) {
        shareBtn.addEventListener("click", () => {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const originalContent = shareBtn.innerHTML;
                shareBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    تم النسخ
                `;
                setTimeout(() => {
                    shareBtn.innerHTML = originalContent;
                }, 2000);
            });
        });
    }

    authStore.subscribe(async (state) => {
        if (state.user) {
            try {
                console.log("Fetching profile for:", state.user.uid);
                const profile = await ProfileService.getProfile(state.user.uid);

                if (profile) {
                    console.log("Profile found:", profile);

                    // Calculate completion
                    const completion =
                        ProfileService.calculateProfileCompletion(profile);
                    if (els.completionPercentage)
                        els.completionPercentage.textContent = `${completion}%`;
                    if (els.completionBar)
                        els.completionBar.style.width = `${completion}%`;

                    if (els.name) els.name.textContent = profile.displayName;
                    if (els.location)
                        els.location.textContent = `${profile.city}, ${profile.country}`;
                    if (els.bio)
                        els.bio.textContent = profile.bio || "لا توجد نبذة";

                    if (els.interests) {
                        els.interests.innerHTML = (profile.interests || [])
                            .map(
                                (i) =>
                                    `<span class="px-3 py-1 bg-teal-50 text-teal-700 rounded-full text-sm font-medium border border-teal-100">${i}</span>`,
                            )
                            .join("");
                    }

                    if (els.age)
                        els.age.textContent = profile.age?.toString() || "--";

                    if (els.status) {
                        const statusMap: Record<string, string> = {
                            single: "أعزب/عزباء",
                            divorced: "مطلق/مطلقة",
                            widowed: "أرمل/أرملة",
                        };
                        els.status.textContent =
                            statusMap[profile.maritalStatus] ||
                            profile.maritalStatus;
                    }

                    if (els.education)
                        els.education.textContent = profile.education || "--";
                    if (els.occupation)
                        els.occupation.textContent = profile.occupation || "--";

                    if (els.lookingFor) {
                        const lookingMap: Record<string, string> = {
                            marriage: "زواج",
                            friendship: "تعارف جاد",
                        };
                        els.lookingFor.textContent =
                            lookingMap[profile.lookingFor] ||
                            profile.lookingFor;
                    }

                    // Profile Image
                    if (
                        profile.photos &&
                        profile.photos.length > 0 &&
                        els.imageContainer
                    ) {
                        els.imageContainer.innerHTML = `<img src="${profile.photos[0]}" alt="${profile.displayName}" class="w-full h-full object-cover" />`;
                    }

                    // Photos Gallery
                    if (
                        els.photos &&
                        profile.photos &&
                        profile.photos.length > 0
                    ) {
                        els.photos.innerHTML = profile.photos
                            .map(
                                (photo) => `
                                <div class="aspect-square rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer">
                                    <img src="${photo}" alt="User photo" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
                                </div>
                            `,
                            )
                            .join("");
                    } else if (els.photos) {
                        els.photos.innerHTML = `<p class="text-gray-400 text-sm col-span-full text-center py-4">لا توجد صور إضافية</p>`;
                    }
                } else {
                    console.log("No profile found, redirecting to create...");
                    window.location.href = "/app/profile/create";
                }
            } catch (error) {
                console.error("Error fetching profile:", error);
            }
        } else if (!state.loading) {
            console.log("Not logged in, redirecting...");
            window.location.href = "/app/login";
        }
    });
</script>
